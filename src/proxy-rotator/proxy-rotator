#!/usr/bin/env python3
"""
AWS Proxy Rotator - IP Rotation through AWS API Gateway
Standalone tool for creating and managing rotating proxy endpoints
"""

import argparse
import sys
import json
import logging
from pathlib import Path
from typing import Optional

# Setup logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class ProxyRotator:
    """Main proxy rotator application"""
    
    def __init__(self):
        self.base_dir = Path(__file__).parent
        self.state_dir = self.base_dir / "state"
        self.lib_dir = self.base_dir / "lib"
        
        # Create necessary directories
        self.state_dir.mkdir(exist_ok=True)
        
        # Add lib to path
        sys.path.insert(0, str(self.lib_dir))
    
    def create_proxy(self, target_url: str, regions: Optional[str] = None, count: Optional[int] = None):
        """Create API Gateway proxies"""
        from api_proxy_manager import APIProxyManager
        
        manager = APIProxyManager(self.base_dir)
        
        if regions:
            region_list = regions.split(',')
        else:
            region_list = None
            
        proxies = manager.create_proxy(target_url, regions=region_list)
        
        if proxies:
            print(f"\n\033[92mCreated {len(proxies)} proxy endpoints:\033[0m\n")
            for proxy in proxies:
                print(f"  Region: {proxy['region']}")
                print(f"  \033[92mProxy URL: {proxy['proxy_url']}\033[0m")
                print(f"  Target: {proxy['target_url']}")
                print(f"  API ID: {proxy['api_id']}\n")
            print("Each request through these proxies will use a different IP address.")
        else:
            print("Failed to create proxies")
    
    def list_proxies(self, region: Optional[str] = None):
        """List all proxies"""
        from api_proxy_manager import APIProxyManager
        
        manager = APIProxyManager(self.base_dir)
        proxies = manager.list_proxies(region)
        
        if proxies:
            print(f"\n\033[92mAPI Gateway Proxies:\033[0m")
            for proxy in proxies:
                print(f"\n  [{proxy.get('created_at', 'Unknown')}]")
                print(f"  Region: {proxy['region']}")
                print(f"  API ID: {proxy['api_id']}")
                print(f"  Name: {proxy['name']}")
                print(f"  \033[92mProxy URL: {proxy['proxy_url']}\033[0m")
                print(f"  Target: {proxy['target_url']}")
        else:
            print("No proxies found")
    
    def delete_proxy(self, api_id: Optional[str] = None, region: Optional[str] = None, delete_all: bool = False):
        """Delete proxies"""
        from api_proxy_manager import APIProxyManager
        
        manager = APIProxyManager(self.base_dir)
        
        if delete_all:
            count = manager.delete_all_proxies()
            print(f"Deleted {count} proxies")
        elif api_id and region:
            success = manager.delete_proxy(api_id, region)
            if success:
                print(f"Successfully deleted proxy {api_id}")
            else:
                print(f"Failed to delete proxy {api_id}")
        else:
            print("Please provide --api-id and --region, or use --all")
    
    def start_local_proxy(self, port: int = 8080):
        """Start local proxy server"""
        from local_proxy import SimpleHTTPProxy
        import asyncio
        
        proxy = SimpleHTTPProxy(self.base_dir, port)
        try:
            asyncio.run(proxy.start())
        except KeyboardInterrupt:
            print("\nProxy server stopped.")
    
    def start_server_with_management(self, proxy_port: int = 8888, management_port: int = 8889):
        """Start both proxy server and management API"""
        from management_server import ProxyManagementServer
        import asyncio
        
        server = ProxyManagementServer(
            base_dir=self.base_dir,
            management_port=management_port,
            proxy_port=proxy_port
        )
        
        try:
            asyncio.run(server.start())
        except KeyboardInterrupt:
            print("\n\nShutting down servers...")
            print("Goodbye!")
    
    def test_proxies(self, url: Optional[str] = None):
        """Test proxy connectivity"""
        from api_proxy_manager import APIProxyManager
        
        manager = APIProxyManager(self.base_dir)
        
        if url:
            working = manager.test_proxy(url)
            if working:
                print(f"\033[92m[OK] Proxy {url} is working\033[0m")
            else:
                print(f"\033[91m[FAIL] Proxy {url} is not responding\033[0m")
        else:
            proxies = manager.list_proxies()
            for proxy in proxies:
                working = manager.test_proxy(proxy['proxy_url'])
                status = "\033[92m[OK]\033[0m" if working else "\033[91m[FAIL]\033[0m"
                print(f"{status} {proxy['proxy_url']} ({proxy['region']})")


def main():
    parser = argparse.ArgumentParser(
        description="AWS Proxy Rotator - IP rotation through API Gateway"
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Commands")
    
    # Create command
    create_parser = subparsers.add_parser("create", help="Create proxy endpoints")
    create_parser.add_argument("--url", required=True, help="Target URL to proxy")
    create_parser.add_argument("--regions", help="Comma-separated AWS regions")
    create_parser.add_argument("--count", type=int, help="Number of proxies to create")
    
    # List command
    list_parser = subparsers.add_parser("list", help="List all proxies")
    list_parser.add_argument("--region", help="Filter by region")
    
    # Delete command
    delete_parser = subparsers.add_parser("delete", help="Delete proxies")
    delete_parser.add_argument("--api-id", help="API Gateway ID")
    delete_parser.add_argument("--region", help="AWS region")
    delete_parser.add_argument("--all", action="store_true", help="Delete all proxies")
    
    # Local proxy command
    local_parser = subparsers.add_parser("local", help="Start local proxy server")
    local_parser.add_argument("--port", type=int, default=8080, help="Local port (default: 8080)")
    
    # Server command (with management API)
    server_parser = subparsers.add_parser("server", help="Start proxy server with management API for browser extension")
    server_parser.add_argument("--proxy-port", type=int, default=8888, help="Proxy port (default: 8888)")
    server_parser.add_argument("--management-port", type=int, default=8889, help="Management API port (default: 8889)")
    
    # Test command
    test_parser = subparsers.add_parser("test", help="Test proxy connectivity")
    test_parser.add_argument("--url", help="Specific proxy URL to test")
    
    # Examples command
    examples_parser = subparsers.add_parser("examples", help="Show usage examples")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        sys.exit(1)
    
    rotator = ProxyRotator()
    
    if args.command == "create":
        rotator.create_proxy(args.url, args.regions, args.count)
    elif args.command == "list":
        rotator.list_proxies(args.region)
    elif args.command == "delete":
        rotator.delete_proxy(args.api_id, args.region, args.all)
    elif args.command == "local":
        rotator.start_local_proxy(args.port)
    elif args.command == "server":
        rotator.start_server_with_management(args.proxy_port, args.management_port)
    elif args.command == "test":
        rotator.test_proxies(args.url)
    elif args.command == "examples":
        print("""
AWS Proxy Rotator - Usage Examples
===================================

# Create proxies in multiple regions
./proxy-rotator create --url https://httpbin.org --regions us-east-1,us-west-2,eu-west-1

# List all proxies
./proxy-rotator list

# Start local proxy server (basic)
./proxy-rotator local --port 8080

# Start proxy server with management API (for browser extension)
./proxy-rotator server --proxy-port 8888 --management-port 8889

# Configure browser
Chrome: --proxy-server="http://localhost:8080"
Firefox: Settings > Network > Manual proxy > localhost:8080
ProxyForge Extension: Auto-connects to ports 8888/8889

# Test proxies
./proxy-rotator test

# Delete all proxies
./proxy-rotator delete --all

# Delete specific proxy
./proxy-rotator delete --api-id abc123 --region us-east-1
        """)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()